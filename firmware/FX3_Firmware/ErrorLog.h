/**
  * Copyright (c) Analog Devices Inc, 2018 - 2020
  * All Rights Reserved.
  *
  * THIS SOFTWARE UTILIZES LIBRARIES DEVELOPED
  * AND MAINTAINED BY CYPRESS INC. THE LICENSE INCLUDED IN
  * THIS REPOSITORY DOES NOT EXTEND TO CYPRESS PROPERTY.
  *
  * Use of this file is governed by the license agreement
  * included in this repository.
  *
  * @file		ErrorLog.h
  * @date		12/6/2019
  * @author		A. Nolan (alex.nolan@analog.com)
  * @brief Header file for the FX3 flash error logging module
 **/

#ifndef ERRORLOG_H_
#define ERRORLOG_H_

/* Include the main header file */
#include "main.h"

/* Defines */

/** The log start address in flash (have to leave space for bootloader starting at flash address 0x0) */
#define LOG_BASE_ADDR							(0x34040)

/** The max log capacity for the ring buffer (32 bytes per entry) */
#define LOG_CAPACITY							1500

/** The flash address of the current log count. This is used to track the head of the error log  */
#define LOG_COUNT_ADDR							(0x34000)

/** Enum to identify the source file which threw an error. More RAM efficient than the __FILE__ directive (gives full path as string) */
typedef enum FileIdentifier
{
	/** Error originated from an unknown file */
	Unknown = 0,

	/** Error originated from main.c */
	Main_c = 1,

	/** Error originated from AppThread.c */
	AppThread_c = 2,

	/** Error originated from StreamThread.c */
	StreamThread_c = 3,

	/** Error originated from PinFunctions.c */
	PinFunctions_c = 4,

	/** Error originated from SpiFunctions.c */
	SpiFunctions_c = 5,

	/** Error originated from StreamFunctions.c */
	StreamFunctions_c = 6,

	/** Error originated from Flash.c */
	Flash_c = 7,

	/** Error originated from ErrorLog.c */
	ErrorLog_c = 8,

	/** Error originating from I2cFunctions.c */
	I2cFunctions_c = 9,

	/** Error originating from HelperFunctions.c */
	HelperFunctions_c = 10

}FileIdentifier;

/**
  * @brief Structure which holds all information about a given error event
  *
  * This struct contains all pertinent information about a given hard crash event. This struct is
  * generated By AdiLogError, and stored to flash in a ring buffer. The total size of this
  * struct is 32 bytes
 **/
typedef struct __attribute__((__packed__)) ErrorMsg
{
	/** FX3 ThreadX RTOS uptime, in milliseconds (0-3) */
	uint32_t Uptime;

	/** The line which caused the error. Should be set by __LINE__ macro in AdiLogError call (4-7) */
	uint32_t Line;

	/** The error code from the set of cypress defined error codes (8 - 11) */
	uint32_t ErrorCode;

	/** The Unix time stamp for when the instance of the FX3 booted. Set by the host PC (12 - 15) */
	uint32_t BootTimeCode;

	/** The file which originated the error. Is file identifier casted into uint (16 - 19) */
	uint32_t File;

	/** The firmware version number string (20 - 31) */
	uint8_t FirmwareVersion[12];
}ErrorMsg;

/* External functions */
void AdiLogError(FileIdentifier File, uint32_t Line, uint32_t ErrorCode);
void WriteErrorLogCount(uint32_t count);

#endif /* ERRORLOG_H_ */
